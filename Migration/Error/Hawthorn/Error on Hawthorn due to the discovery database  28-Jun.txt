TASK [edx_django_service : migrate database] ***************************************************************************************
fatal: [localhost]: FAILED! => {"changed": true, "cmd": ["make", "migrate"], "delta": "0:00:02.936774", "end": "2021-06-28 14:51:26.903251", "failed": true, "rc": 2, "start": "2021-06-28 14:51:23.966477", "stderr": "Traceback (most recent call last):\n  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/django/db/backends/utils.py\", line 64, in execute\n    return self.cursor.execute(sql, params)\n  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/django/db/backends/mysql/base.py\", line 101, in execute\n    return self.cursor.execute(query, args)\n  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/MySQLdb/cursors.py\", line 250, in execute\n    self.errorhandler(self, exc, value)\n  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/MySQLdb/connections.py\", line 42, in defaulterrorhandler\n    raise errorvalue\n  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/MySQLdb/cursors.py\", line 247, in execute\n    res = self._query(query)\n  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/MySQLdb/cursors.py\", line 411, in _query\n    rowcount = self._do_query(q)\n  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/MySQLdb/cursors.py\", line 374, in _do_query\n    db.query(q)\n  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/MySQLdb/connections.py\", line 270, in query\n    _mysql.connection.query(self, query)\n_mysql_exceptions.IntegrityError: (1215, 'Cannot add foreign key constraint')\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"manage.py\", line 15, in <module>\n    execute_from_command_line(sys.argv)\n  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/django/core/management/__init__.py\", line 364, in execute_from_command_line\n    utility.execute()\n  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/django/core/management/__init__.py\", line 356, in execute\n    self.fetch_command(subcommand).run_from_argv(self.argv)\n  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/django/core/management/base.py\", line 283, in run_from_argv\n    self.execute(*args, **cmd_options)\n  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/django/core/management/base.py\", line 330, in execute\n    output = self.handle(*args, **options)\n  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/django/core/management/commands/migrate.py\", line 204, in handle\n    fake_initial=fake_initial,\n  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/django/db/migrations/executor.py\", line 115, in migrate\n    state = self._migrate_all_forwards(state, plan, full_plan, fake=fake, fake_initial=fake_initial)\n  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/django/db/migrations/executor.py\", line 145, in _migrate_all_forwards\n    state = self.apply_migration(state, migration, fake=fake, fake_initial=fake_initial)\n  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/django/db/migrations/executor.py\", line 244, in apply_migration\n    state = migration.apply(state, schema_editor)\n  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/django/db/backends/base/schema.py\", line 109, in __exit__\n    self.execute(sql)\n  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/django/db/backends/base/schema.py\", line 136, in execute\n    cursor.execute(sql, params)\n  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/django/db/backends/utils.py\", line 64, in execute\n    return self.cursor.execute(sql, params)\n  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/django/db/utils.py\", line 94, in __exit__\n    six.reraise(dj_exc_type, dj_exc_value, traceback)\n  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/django/utils/six.py\", line 685, in reraise\n    raise value.with_traceback(tb)\n  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/django/db/backends/utils.py\", line 64, in execute\n    return self.cursor.execute(sql, params)\n  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/django/db/backends/mysql/base.py\", line 101, in execute\n    return self.cursor.execute(query, args)\n  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/MySQLdb/cursors.py\", line 250, in execute\n    self.errorhandler(self, exc, value)\n  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/MySQLdb/connections.py\", line 42, in defaulterrorhandler\n    raise errorvalue\n  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/MySQLdb/cursors.py\", line 247, in execute\n    res = self._query(query)\n  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/MySQLdb/cursors.py\", line 411, in _query\n    rowcount = self._do_query(q)\n  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/MySQLdb/cursors.py\", line 374, in _do_query\n    db.query(q)\n  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/MySQLdb/connections.py\", line 270, in query\n    _mysql.connection.query(self, query)\ndjango.db.utils.IntegrityError: (1215, 'Cannot add foreign key constraint')\nmake: *** [migrate] Error 1", "stderr_lines": ["Traceback (most recent call last):", "  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/django/db/backends/utils.py\", line 64, in execute", "    return self.cursor.execute(sql, params)", "  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/django/db/backends/mysql/base.py\", line 101, in execute", "    return self.cursor.execute(query, args)", "  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/MySQLdb/cursors.py\", line 250, in execute", "    self.errorhandler(self, exc, value)", "  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/MySQLdb/connections.py\", line 42, in defaulterrorhandler", "    raise errorvalue", "  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/MySQLdb/cursors.py\", line 247, in execute", "    res = self._query(query)", "  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/MySQLdb/cursors.py\", line 411, in _query", "    rowcount = self._do_query(q)", "  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/MySQLdb/cursors.py\", line 374, in _do_query", "    db.query(q)", "  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/MySQLdb/connections.py\", line 270, in query", "    _mysql.connection.query(self, query)", "_mysql_exceptions.IntegrityError: (1215, 'Cannot add foreign key constraint')", "", "The above exception was the direct cause of the following exception:", "", "Traceback (most recent call last):", "  File \"manage.py\", line 15, in <module>", "    execute_from_command_line(sys.argv)", "  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/django/core/management/__init__.py\", line 364, in execute_from_command_line", "    utility.execute()", "  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/django/core/management/__init__.py\", line 356, in execute", "    self.fetch_command(subcommand).run_from_argv(self.argv)", "  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/django/core/management/base.py\", line 283, in run_from_argv", "    self.execute(*args, **cmd_options)", "  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/django/core/management/base.py\", line 330, in execute", "    output = self.handle(*args, **options)", "  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/django/core/management/commands/migrate.py\", line 204, in handle", "    fake_initial=fake_initial,", "  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/django/db/migrations/executor.py\", line 115, in migrate", "    state = self._migrate_all_forwards(state, plan, full_plan, fake=fake, fake_initial=fake_initial)", "  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/django/db/migrations/executor.py\", line 145, in _migrate_all_forwards", "    state = self.apply_migration(state, migration, fake=fake, fake_initial=fake_initial)", "  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/django/db/migrations/executor.py\", line 244, in apply_migration", "    state = migration.apply(state, schema_editor)", "  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/django/db/backends/base/schema.py\", line 109, in __exit__", "    self.execute(sql)", "  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/django/db/backends/base/schema.py\", line 136, in execute", "    cursor.execute(sql, params)", "  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/django/db/backends/utils.py\", line 64, in execute", "    return self.cursor.execute(sql, params)", "  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/django/db/utils.py\", line 94, in __exit__", "    six.reraise(dj_exc_type, dj_exc_value, traceback)", "  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/django/utils/six.py\", line 685, in reraise", "    raise value.with_traceback(tb)", "  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/django/db/backends/utils.py\", line 64, in execute", "    return self.cursor.execute(sql, params)", "  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/django/db/backends/mysql/base.py\", line 101, in execute", "    return self.cursor.execute(query, args)", "  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/MySQLdb/cursors.py\", line 250, in execute", "    self.errorhandler(self, exc, value)", "  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/MySQLdb/connections.py\", line 42, in defaulterrorhandler", "    raise errorvalue", "  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/MySQLdb/cursors.py\", line 247, in execute", "    res = self._query(query)", "  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/MySQLdb/cursors.py\", line 411, in _query", "    rowcount = self._do_query(q)", "  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/MySQLdb/cursors.py\", line 374, in _do_query", "    db.query(q)", "  File \"/edx/app/discovery/venvs/discovery/lib/python3.5/site-packages/MySQLdb/connections.py\", line 270, in query", "    _mysql.connection.query(self, query)", "django.db.utils.IntegrityError: (1215, 'Cannot add foreign key constraint')", "make: *** [migrate] Error 1"], "stdout": "python manage.py migrate --noinput\nOperations to perform:\n  Apply all migrations: admin, auth, catalogs, contenttypes, core, course_metadata, django_comments, guardian, ietf_language_tags, publisher, publisher_comments, sessions, sites, social_django, taggit, waffle\nRunning migrations:\n  Applying core.0005_auto_20170830_1246... OK\n  Applying core.0006_partner_lms_url... OK\n  Applying core.0007_auto_20171004_1133... OK\n  Applying course_metadata.0057_auto_20170915_1528...Makefile:59: recipe for target 'migrate' failed", "stdout_lines": ["python manage.py migrate --noinput", "Operations to perform:", "  Apply all migrations: admin, auth, catalogs, contenttypes, core, course_metadata, django_comments, guardian, ietf_language_tags, publisher, publisher_comments, sessions, sites, social_django, taggit, waffle", "Running migrations:", "  Applying core.0005_auto_20170830_1246... OK", "  Applying core.0006_partner_lms_url... OK", "  Applying core.0007_auto_20171004_1133... OK", "  Applying course_metadata.0057_auto_20170915_1528...Makefile:59: recipe for target 'migrate' failed"]}

---------------------------------------------------------------------------------------------------------------------------------------------
Reason: Discovery database has actually  103 tables of “utf8” character set for the Ginkgo release, but we found 96 tables with "latin1" character set in the production setup. 
Solution:  It didn't have user data so we replaced it with a fresh discovery database for the Ginkgo.2 release.
